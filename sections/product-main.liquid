{%- style -%}
  /* --- LAYOUT & STRUKTUR (Carhartt Architektur) --- */
  
  /* Container übernimmt Theme-Breite, erzwingt keine Hintergrundfarbe */
  .product-section-wrapper {
    max-width: 100%;
    margin: 0 auto;
    /* Hintergrundfarbe entfernt, damit dein Theme-Grau bleibt */
  }

  .product-grid-container {
    display: flex;
    flex-direction: column;
  }

  /* Desktop Split: Links Bilder, Rechts Info */
  @media (min-width: 1024px) {
    .product-grid-container {
      display: grid;
      grid-template-columns: 65% 35%; /* Carhartt Verhältnis */
      align-items: start;
      gap: 0;
    }
  }

  /* --- LINKE SPALTE: GALERIE --- */
  .gallery-column {
    width: 100%;
    position: relative;
  }

  /* Desktop Grid: 2 Bilder nebeneinander */
  .gallery-desktop-grid {
    display: none;
  }

  @media (min-width: 1024px) {
    .gallery-desktop-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px; /* Feiner Abstand zwischen Bildern */
      padding-right: 20px;
    }
    
    .gallery-item {
      cursor: zoom-in;
      display: block;
      line-height: 0; /* Entfernt Lücken unter Bildern */
    }

    .gallery-item img {
      width: 100%;
      height: auto;
      object-fit: cover;
      display: block;
    }
  }

  /* Mobile: Standard Bild */
  .gallery-mobile-stack {
    display: block;
  }
  @media (min-width: 1024px) { .gallery-mobile-stack { display: none; } }
  .gallery-mobile-stack img { width: 100%; display: block; margin-bottom: 4px; }

  /* --- RECHTE SPALTE: INFO (Sticky) --- */
  .info-column {
    padding: 20px;
  }

  @media (min-width: 1024px) {
    .info-column {
      position: sticky;
      top: 20px; /* Bleibt beim Scrollen stehen */
      padding: 40px 50px; 
      max-height: 100vh;
      overflow-y: auto;
    }
  }

  /* --- LIGHTBOX (Zoom Overlay) --- */
  .lightbox-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.98); /* Fast deckendes Weiß */
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .lightbox-overlay.active { opacity: 1; pointer-events: all; }
  .lightbox-img { max-height: 90vh; max-width: 90vw; object-fit: contain; }
  .lightbox-close { position: absolute; top: 20px; right: 20px; font-size: 2rem; background:none; border:none; cursor:pointer; }
  .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); font-size: 2rem; background:none; border:none; cursor:pointer; padding:20px; }
  .lightbox-prev { left: 10px; }
  .lightbox-next { right: 10px; }

  /* --- ELEMENTE & ABSTÄNDE --- */
  
  /* Titel & Preis erben vom Theme (h1, h2...), wir regeln nur den Abstand */
  .product-header {
    margin-bottom: 0;
  }
  
  .spacer-large { height: 40px; }
  .spacer-medium { height: 25px; }

  /* SWATCHES (Die Farb-Bilder) */
  .swatch-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 8px;
  }

  .swatch-item {
    width: 48px; /* Größe der Farbbilder */
    height: 48px;
    padding: 0;
    border: 1px solid transparent; /* Unsichtbarer Rahmen */
    cursor: pointer;
    background: transparent;
    overflow: hidden;
    transition: border-color 0.2s;
  }
  
  .swatch-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Border-Logik für "Whateverman" Style */
  .swatch-item:hover { border-color: #999; }
  .swatch-item.is-active { 
    border-color: #000; /* Aktiv = Schwarzer Rahmen */
    box-shadow: inset 0 0 0 1px #fff; /* Kleiner Innenabstand für Lesbarkeit */
  }

  .color-name-display {
    font-size: 0.9rem;
    color: var(--color-base-text); /* Theme Textfarbe */
    opacity: 0.8;
  }

  /* GRÖSSEN BUTTONS */
  .size-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .size-btn {
    min-width: 50px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(0,0,0,0.1); /* Subtiler Rahmen */
    background: transparent; /* Theme Hintergrund durchlassen */
    color: var(--color-base-text);
    cursor: pointer;
    font-size: 0.9rem;
  }

  .size-btn:hover { border-color: #000; }
  
  .size-btn.is-active {
    background: #000; /* Oder Theme Primary Color */
    color: #fff;
    border-color: #000;
  }
  
  .size-btn:disabled {
    opacity: 0.4;
    text-decoration: line-through;
    cursor: not-allowed;
  }

  /* ADD BUTTON */
  .add-to-cart-btn {
    width: 100%;
    margin-top: 30px;
    padding: 15px;
    /* Style wird vom Theme Button geerbt, aber volle Breite erzwungen */
  }

{%- endstyle -%}

<div class="product-section-wrapper">
  
  <div id="lightbox" class="lightbox-overlay">
    <button class="lightbox-close" onclick="closeLightbox()">✕</button>
    <button class="lightbox-nav lightbox-prev" onclick="changeSlide(-1)">❮</button>
    <img id="lightbox-image" class="lightbox-img" src="" alt="Zoom">
    <button class="lightbox-nav lightbox-next" onclick="changeSlide(1)">❯</button>
  </div>

  <div class="product-grid-container">
    
    <div class="gallery-column">
      <div class="gallery-mobile-stack">
        {% if product.featured_image %}
          <img src="{{ product.featured_image | image_url: width: 800 }}" alt="{{ product.title }}">
        {% endif %}
      </div>
      <div class="gallery-desktop-grid">
        {% for image in product.images %}
          <div class="gallery-item" onclick="openLightbox({{ forloop.index0 }})">
            <img src="{{ image | image_url: width: 1200 }}" alt="{{ image.alt | escape }}" loading="lazy">
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="info-column">
      
      <form action="/cart/add" method="post" enctype="multipart/form-data" id="add-to-cart-form">
        
        <h1 class="product-title h2">{{ product.title }}</h1>
        
        <div class="product-price h4">
          {{ product.price | money }}
          {% if product.compare_at_price > product.price %}
            <s style="opacity: 0.6; font-size: 0.9em; margin-left: 8px;">{{ product.compare_at_price | money }}</s>
          {% endif %}
        </div>

        <div class="spacer-large"></div>

        {% unless product.has_only_default_variant %}
          
          {%- comment -%} OPTIONEN FINDEN (Color & Size) {%- endcomment -%}
          {% assign color_opt = nil %}
          {% assign size_opt = nil %}
          
          {% for option in product.options_with_values %}
             {% assign opt_name = option.name | downcase %}
             {% if opt_name contains 'color' or opt_name contains 'colour' or opt_name contains 'farbe' %}
               {% assign color_opt = option %}
             {% endif %}
             {% if opt_name contains 'size' or opt_name contains 'größe' %}
               {% assign size_opt = option %}
             {% endif %}
          {% endfor %}

          {% if color_opt %}
            <div class="swatch-grid">
              {% for value in color_opt.values %}
                
                {% assign swatch_image_url = nil %}
                
                {% for variant in product.variants %}
                  {% if variant.option1 == value or variant.option2 == value or variant.option3 == value %}
                    {% if variant.featured_image %}
                      {% assign swatch_image_url = variant.featured_image | image_url: width: 200, height: 200, crop: 'center' %}
                      {% break %} {% endif %}
                  {% endif %}
                {% endfor %}

                <button type="button" 
                  class="swatch-item {% if forloop.first %}is-active{% endif %}" 
                  data-value="{{ value }}"
                  onclick="selectColor(this, '{{ value }}')"
                  title="{{ value }}"
                >
                  {% if swatch_image_url %}
                    <img src="{{ swatch_image_url }}" alt="{{ value }}">
                  {% else %}
                    <span style="display:block; width:100%; height:100%; background-color: #ddd; display:flex; align-items:center; justify-content:center; font-size:0.6rem;">{{ value | slice: 0, 3 }}</span>
                  {% endif %}
                </button>
              {% endfor %}
            </div>
            
            <div class="color-name-display" id="color-name-text">{{ color_opt.values.first }}</div>
          {% endif %}

          <div class="spacer-medium"></div>

          {% if size_opt %}
            <div style="margin-bottom: 8px; font-size: 0.9rem;">Select Size</div>
            <div class="size-grid">
              {% for value in size_opt.values %}
                <button type="button" class="size-btn" data-value="{{ value }}" onclick="selectSize(this, '{{ value }}')">
                  {{ value }}
                </button>
              {% endfor %}
            </div>
          {% endif %}

          <select name="id" id="shopify-master-select" style="display:none;">
            {% for variant in product.variants %}
              <option value="{{ variant.id }}" 
                data-opt1="{{ variant.option1 }}" 
                data-opt2="{{ variant.option2 }}" 
                data-opt3="{{ variant.option3 }}"
                {% unless variant.available %}disabled{% endunless %}
              >
                {{ variant.title }}
              </option>
            {% endfor %}
          </select>

        {% endunless %}

        <button type="submit" id="main-add-btn" class="add-to-cart-btn button btn btn--primary" disabled>
          Select Size
        </button>

        <div style="margin-top: 40px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 15px;">
           <details>
             <summary style="cursor:pointer; padding: 10px 0;">Details</summary>
             <div style="padding: 10px 0; font-size: 0.9rem; line-height: 1.6;">{{ product.description }}</div>
           </details>
        </div>

      </form>
    </div>
  </div>
</div>

<script>
  /* --- LIGHTBOX (Zoom) --- */
  const lbImages = [
    {% for image in product.images %}
      "{{ image | image_url: width: 2000 }}"{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];
  let lbIndex = 0;
  const lbOverlay = document.getElementById('lightbox');
  const lbImg = document.getElementById('lightbox-image');

  function openLightbox(idx) {
    lbIndex = idx;
    lbImg.src = lbImages[idx];
    lbOverlay.classList.add('active');
    document.body.style.overflow = 'hidden';
  }
  function closeLightbox() {
    lbOverlay.classList.remove('active');
    document.body.style.overflow = '';
  }
  function changeSlide(dir) {
    lbIndex += dir;
    if(lbIndex >= lbImages.length) lbIndex = 0;
    if(lbIndex < 0) lbIndex = lbImages.length - 1;
    lbImg.src = lbImages[lbIndex];
  }
  
  // Tastatursteuerung
  document.addEventListener('keydown', e => {
    if(!lbOverlay.classList.contains('active')) return;
    if(e.key === "Escape") closeLightbox();
    if(e.key === "ArrowRight") changeSlide(1);
    if(e.key === "ArrowLeft") changeSlide(-1);
  });

  /* --- VARIANTEN LOGIK --- */
  let curColor = "{{ color_opt.values.first }}";
  let curSize = null;

  function selectColor(btn, val) {
    document.querySelectorAll('.swatch-item').forEach(b => b.classList.remove('is-active'));
    btn.classList.add('is-active');
    document.getElementById('color-name-text').textContent = val;
    curColor = val;
    updateState();
  }

  function selectSize(btn, val) {
    document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('is-active'));
    btn.classList.add('is-active');
    curSize = val;
    updateState();
  }

  function updateState() {
    const select = document.getElementById('shopify-master-select');
    const btn = document.getElementById('main-add-btn');
    let validVariant = null;

    // Finde passende Variante
    for(let opt of select.options) {
      const o1 = opt.getAttribute('data-opt1');
      const o2 = opt.getAttribute('data-opt2');
      const o3 = opt.getAttribute('data-opt3');
      
      const matchC = (o1 === curColor || o2 === curColor || o3 === curColor);
      const matchS = (o1 === curSize || o2 === curSize || o3 === curSize);

      if(matchC && matchS) {
        validVariant = opt;
        break;
      }
    }
    
    // Update Button Text & Verfügbarkeit
    if(validVariant && !validVariant.disabled) {
      btn.disabled = false;
      btn.textContent = "Add to Bag";
      select.value = validVariant.value;
    } else {
      btn.disabled = true;
      if(validVariant && validVariant.disabled) {
        btn.textContent = "Sold Out";
      } else {
        btn.textContent = curSize ? "Unavailable" : "Select Size";
      }
    }
  }
</script>
