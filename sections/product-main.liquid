{%- style -%}
  .product-main {
    padding: 0;
    background: var(--color-background-secondary, #f5f5f5);
  }
  
  @media (min-width: 768px) {
    .product-main {
      padding: 0;
    }
  }
  
  .product-main__wrapper {
    max-width: 100%;
    margin: 0 auto;
    display: grid;
    gap: 0;
  }
  
  @media (min-width: 1024px) {
    .product-main__wrapper {
      grid-template-columns: 65% 35%; /* Carhartt Verhältnis */
      gap: 0;
      align-items: start;
    }
  }
  
  /* --- NEU: Lightbox Overlay Styles --- */
  .lightbox-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5); /* Punkt 3: Leicht abgedunkelt */
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .lightbox-overlay.active { opacity: 1; pointer-events: all; }
  
  .lightbox-img { 
    max-height: 90vh; 
    max-width: 90vw; 
    object-fit: contain; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  }
  
  .lightbox-close { 
    position: absolute; top: 20px; right: 20px; 
    font-size: 2.5rem; color: white; background:none; border:none; cursor:pointer; 
  }
  
  .lightbox-nav { 
    position: absolute; top: 50%; transform: translateY(-50%); 
    font-size: 3rem; color: white; background:none; border:none; cursor:pointer; padding:20px; 
  }
  .lightbox-prev { left: 10px; }
  .lightbox-next { right: 10px; }


  /* --- UPDATE: Gallery Layout (Carhartt Style) --- */
  .product-main__gallery {
    background: var(--color-background-secondary, #f5f5f5);
    position: relative;
  }
  
  .product-main__desktop-gallery {
    display: none;
  }
  
  @media (min-width: 1024px) {
    .product-main__desktop-gallery {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      /* Punkt 1: Exakte Abstände zwischen den Bildern */
      gap: 4px; 
      padding-right: 4px; /* Abstand zur Info-Spalte */
    }
  }
  
  .product-main__image-item {
    /* Entfernt Aspect-Ratio Zwang für besseres Fitting */
    position: relative;
    background: var(--color-background-secondary, #f5f5f5);
    overflow: hidden;
    cursor: zoom-in; /* Punkt 2: Lupen-Cursor */
  }
  
  .product-main__image-item img {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
    transition: opacity 0.3s ease;
  }
  
  .product-main__image-item:hover img {
    opacity: 0.9; /* Leichter Hover-Effekt statt Zoom */
  }

  /* Mobile: Single image with arrows */
  .product-main__mobile-gallery {
    position: relative;
    display: block;
  }

  @media (min-width: 1024px) {
    .product-main__mobile-gallery {
      display: none;
    }
  }

  .product-main__mobile-image {
    aspect-ratio: 3/4;
    background: var(--color-background-secondary, #f5f5f5);
    overflow: hidden;
  }

  .product-main__mobile-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-main__mobile-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    color: #000;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  .product-main__mobile-nav--prev {
    left: 12px;
  }

  .product-main__mobile-nav--next {
    right: 12px;
  }

  .product-main__mobile-nav svg {
    width: 20px;
    height: 20px;
  }

  .product-main__mobile-counter {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 0.75rem;
    padding: 0.35rem 1rem;
    border-radius: 2px;
    letter-spacing: 0.1em;
  }
  
  /* Product Info - Sticky sidebar on Desktop */
  .product-main__info {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    padding: 1.5rem;
    background: var(--color-background);
  }
  
  @media (min-width: 768px) {
    .product-main__info {
      padding: 2rem;
    }
  }
  
  @media (min-width: 1024px) {
    .product-main__info {
      position: sticky;
      top: 40px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      padding: 3rem 4rem; /* Mehr Abstand innen */
    }
  }
  
  .product-main__header {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .product-main__title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(1.25rem, 2.5vw, 1.5rem);
    line-height: 1.2;
    margin: 0;
    font-weight: 400;
    letter-spacing: 0.02em;
  }
  
  .product-main__price {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.125rem;
  }
  
  .product-main__price-current {
    font-size: 0.9rem;
    color: var(--color-text-muted);
  }
  
  .product-main__price-compare {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    text-decoration: line-through;
    opacity: 0.6;
  }
  
  .product-main__price-badge {
    padding: 0.15rem 0.4rem;
    background: var(--color-secondary);
    color: var(--color-background);
    font-size: 0.6rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  /* Color Swatches */
  .product-main__colors {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .product-main__color-swatches {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
  }
  
  @media (min-width: 768px) {
    .product-main__color-swatches {
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
    }
  }
  
  .product-main__color-swatch {
    aspect-ratio: 1/1;
    width: 100%;
    padding: 0;
    border: 1px solid transparent;
    background: var(--color-background-secondary, #f5f5f5);
    cursor: pointer;
    overflow: hidden;
    transition: border-color 0.2s ease;
  }
  
  .product-main__color-swatch:hover,
  .product-main__color-swatch.is-active {
    border-color: var(--color-text);
  }
  
  .product-main__color-swatch img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .product-main__color-swatch--fallback {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .product-main__color-dot {
    width: 70%;
    height: 70%;
    border-radius: 50%;
    border: 1px solid rgba(0,0,0,0.1);
  }
  
  .product-main__color-name {
    font-size: 0.85rem;
    color: var(--color-text);
  }
  
  /* Size Options */
  .product-main__sizes {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .product-main__size-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  
  @media (min-width: 400px) {
    .product-main__size-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }
  
  @media (min-width: 768px) {
    .product-main__size-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  .product-main__size-btn {
    padding: 0.875rem 0.5rem;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--color-text);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s ease;
    text-align: center;
  }
  
  .product-main__size-btn:hover:not(:disabled) {
    border-color: var(--color-text);
  }
  
  .product-main__size-btn.is-active {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }
  
  .product-main__size-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    text-decoration: line-through;
  }
  
  /* Variants Group */
  .product-main__variant-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .product-main__variant-label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .product-main__variant-options {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }
  
  .product-main__variant-btn {
    padding: 0.5rem 1rem;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--color-text);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .product-main__variant-btn:hover,
  .product-main__variant-btn.is-active {
    border-color: var(--color-text);
    background: var(--color-text);
    color: var(--color-background);
  }
  
  /* Add to Cart */
  .product-main__add-btn {
    width: 100%;
    padding: 1rem;
    font-size: 0.85rem;
    margin-top: 0.5rem;
    transition: opacity 0.2s ease;
  }
  
  .product-main__add-btn:disabled,
  .product-main__add-btn.is-disabled {
    background: rgba(255,255,255,0.1);
    color: var(--color-text-muted);
    cursor: not-allowed;
  }
  
  /* Info List */
  .product-main__info-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .product-main__info-item {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    line-height: 1.4;
  }
  
  .product-main__info-item svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    color: var(--color-primary);
    margin-top: 1px;
  }
  
  /* Accordion */
  .product-main__details {
    display: flex;
    flex-direction: column;
    margin-top: 0.5rem;
  }
  
  .product-main__accordion {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .product-main__accordion:first-child {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .product-main__accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding: 1rem 0;
    background: transparent;
    border: none;
    color: var(--color-text);
    font-size: 0.85rem;
    cursor: pointer;
    text-align: left;
  }
  
  .product-main__accordion-header:hover {
    color: var(--color-primary);
  }
  
  .product-main__accordion-icon {
    width: 14px;
    height: 14px;
    transition: transform 0.3s ease;
  }
  
  .product-main__accordion.is-open .product-main__accordion-icon {
    transform: rotate(90deg);
  }
  
  .product-main__accordion-content {
    display: none;
    padding-bottom: 1rem;
    color: var(--color-text-muted);
    font-size: 0.8rem;
    line-height: 1.7;
  }
  
  .product-main__accordion.is-open .product-main__accordion-content {
    display: block;
  }
  
  .product-main__accordion-content ul {
    margin: 0;
    padding-left: 1.25rem;
  }
  
  .product-main__accordion-content li {
    margin-bottom: 0.25rem;
  }
  
  /* Sticky Mobile Bar */
  .product-main__sticky-bar {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.75rem 1rem;
    background: var(--color-background);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 100;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
  }
  
  .product-main__sticky-bar.is-visible {
    display: block;
  }
  
  .product-main__sticky-inner {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    max-width: var(--container-width);
    margin: 0 auto;
  }
  
  .product-main__sticky-info {
    flex: 1;
    min-width: 0;
  }
  
  .product-main__sticky-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .product-main__sticky-price {
    font-size: 0.8rem;
    color: var(--color-text-muted);
  }
  
  .product-main__sticky-btn {
    flex-shrink: 0;
    padding: 0.75rem 1.5rem;
    font-size: 0.8rem;
  }
  
  @media (min-width: 768px) {
    .product-main__sticky-bar {
      display: none !important;
    }
  }
  
  .visually-hidden {
    position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;
  }
{%- endstyle -%}

{%- comment -%} Detect options {%- endcomment -%}
{% assign color_option = nil %}
{% assign size_option = nil %}
{% assign other_options = '' %}

{% for option in product.options_with_values %}
  {% assign option_name_downcase = option.name | downcase %}
  {% if option_name_downcase == 'color' or option_name_downcase == 'colour' or option_name_downcase == 'farbe' %}
    {% assign color_option = option %}
  {% elsif option_name_downcase == 'size' or option_name_downcase == 'größe' or option_name_downcase == 'groesse' %}
    {% assign size_option = option %}
  {% else %}
    {% if other_options != '' %}
      {% assign other_options = other_options | append: ',' %}
    {% endif %}
    {% assign other_options = other_options | append: option.name %}
  {% endif %}
{% endfor %}

<section class="product-main">
  
  <div id="lightbox" class="lightbox-overlay">
    <button class="lightbox-close" onclick="closeLightbox()">✕</button>
    <button class="lightbox-nav lightbox-prev" onclick="changeSlide(-1)">❮</button>
    <img id="lightbox-image" class="lightbox-img" src="" alt="Zoom">
    <button class="lightbox-nav lightbox-next" onclick="changeSlide(1)">❯</button>
  </div>

  <div class="product-main__wrapper">
    <div class="product-main__gallery">
      <div class="product-main__mobile-gallery">
        <div class="product-main__mobile-image">
          {% if product.featured_image != blank %}
            <img src="{{ product.featured_image | image_url: width: 800 }}" alt="{{ product.featured_image.alt | default: product.title }}" id="product-mobile-image">
          {% else %}
            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
          {% endif %}
        </div>
        {% if product.images.size > 1 %}
          <button type="button" class="product-main__mobile-nav product-main__mobile-nav--prev" data-mobile-nav="prev"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
          <button type="button" class="product-main__mobile-nav product-main__mobile-nav--next" data-mobile-nav="next"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
          <div class="product-main__mobile-counter"><span id="mobile-image-current">1</span> / <span id="mobile-image-total">{{ product.images.size }}</span></div>
        {% endif %}
      </div>

      <div class="product-main__desktop-gallery" id="desktop-gallery">
        {% for image in product.images %}
          <div class="product-main__image-item" onclick="openLightbox({{ forloop.index0 }})">
            <img src="{{ image | image_url: width: 800 }}" alt="{{ image.alt | default: product.title }}" loading="{% if forloop.index <= 2 %}eager{% else %}lazy{% endif %}">
          </div>
        {% endfor %}
      </div>
    </div>
    
    <div class="product-main__info">
      <div class="product-main__header">
        <h1 class="product-main__title">{{ product.title }}</h1>
        <div class="product-main__price">
          <span class="product-main__price-current">{{ product.price | money }}</span>
          {% if product.compare_at_price > product.price %}
            <span class="product-main__price-compare">{{ product.compare_at_price | money }}</span>
            {% assign discount = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price %}
            <span class="product-main__price-badge">-{{ discount }}%</span>
          {% endif %}
        </div>
      </div>
      
      <form action="/cart/add" method="post" enctype="multipart/form-data" id="product-form">
        {% unless product.has_only_default_variant %}
          
          {% if color_option %}
            <div class="product-main__colors">
              <div class="product-main__color-swatches">
                {% for value in color_option.values %}
                  {% assign color_image = nil %}
                  {% assign color_images_for_gallery = '' %}
                  {% for variant in product.variants %}
                    {% if variant.option1 == value or variant.option2 == value or variant.option3 == value %}
                      {% if variant.featured_image != blank %}
                        {% if color_image == nil %}{% assign color_image = variant.featured_image %}{% endif %}
                        {% if color_images_for_gallery != '' %}{% assign color_images_for_gallery = color_images_for_gallery | append: ',' %}{% endif %}
                        {% assign color_images_for_gallery = color_images_for_gallery | append: variant.featured_image | image_url: width: 800 %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% assign color_handle = value | handleize %}
                  <button type="button" class="product-main__color-swatch {% if forloop.first %}is-active{% endif %} {% unless color_image %}product-main__color-swatch--fallback{% endunless %}" data-option="{{ color_option.name }}" data-value="{{ value }}" data-color-handle="{{ color_handle }}" {% if color_image %}data-image="{{ color_image | image_url: width: 800 }}"{% endif %} data-gallery-images="{{ color_images_for_gallery }}" title="{{ value }}">
                    {% if color_image %}
                      <img src="{{ color_image | image_url: width: 150 }}" alt="{{ value }}" loading="lazy">
                    {% else %}
                      <span class="product-main__color-dot" style="background-color: {{ color_handle }};"></span>
                    {% endif %}
                  </button>
                {% endfor %}
              </div>
              <span class="product-main__color-name" id="selected-color-name">{{ color_option.values.first }}</span>
            </div>
          {% endif %}
          
          {% if size_option %}
            <div class="product-main__sizes">
              <div class="product-main__size-grid">
                {% for value in size_option.values %}
                  <button type="button" class="product-main__size-btn" data-option="{{ size_option.name }}" data-value="{{ value }}">{{ value }}</button>
                {% endfor %}
              </div>
            </div>
          {% endif %}
          
          {% for option in product.options_with_values %}
            {% assign option_name_downcase = option.name | downcase %}
            {% unless option_name_downcase == 'color' or option_name_downcase == 'colour' or option_name_downcase == 'farbe' or option_name_downcase == 'size' or option_name_downcase == 'größe' or option_name_downcase == 'groesse' %}
              <div class="product-main__variant-group">
                <span class="product-main__variant-label">{{ option.name }}</span>
                <div class="product-main__variant-options">
                  {% for value in option.values %}
                    <button type="button" class="product-main__variant-btn {% if forloop.first %}is-active{% endif %}" data-option="{{ option.name }}" data-value="{{ value }}">{{ value }}</button>
                  {% endfor %}
                </div>
              </div>
            {% endunless %}
          {% endfor %}
        {% endunless %}
        
        <select name="id" id="product-select" class="visually-hidden">
          {% for variant in product.variants %}
            <option value="{{ variant.id }}" {% unless variant.available %}disabled{% endunless %} data-option1="{{ variant.option1 }}" data-option2="{{ variant.option2 }}" data-option3="{{ variant.option3 }}">{{ variant.title }} - {{ variant.price | money }}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="quantity" value="1">
        <button type="submit" class="btn btn-gradient product-main__add-btn is-disabled" data-add-to-cart id="add-to-cart-btn" disabled data-select-size="{{ 'products.product.select_size' | t }}" data-add-to-cart-text="{{ 'products.product.add_to_cart' | t }}" data-sold-out="{{ 'products.product.sold_out' | t }}">{{ 'products.product.select_size' | t }}</button>
      </form>
      
      <ul class="product-main__info-list">
        <li class="product-main__info-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg><span>Free shipping $100+</span></li>
        <li class="product-main__info-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg><span>30-day returns</span></li>
        <li class="product-main__info-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg><span>Secure checkout</span></li>
      </ul>
      
      <div class="product-main__details">
        {% if product.description != blank %}
          <div class="product-main__accordion">
            <button type="button" class="product-main__accordion-header"><span>Details</span><svg class="product-main__accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
            <div class="product-main__accordion-content">{{ product.description }}</div>
          </div>
        {% endif %}
        <div class="product-main__accordion">
          <button type="button" class="product-main__accordion-header"><span>Shipping & Returns</span><svg class="product-main__accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
          <div class="product-main__accordion-content"><ul><li>Free standard shipping on orders over $100 AUD</li><li>Express shipping available at checkout</li><li>International shipping to select countries</li><li>30-day easy returns for unworn items</li><li>Please allow 2-5 business days for processing</li></ul></div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="product-main__sticky-bar" id="sticky-add-to-cart">
    <div class="product-main__sticky-inner">
      <div class="product-main__sticky-info"><div class="product-main__sticky-title">{{ product.title }}</div><div class="product-main__sticky-price">{{ product.price | money }}</div></div>
      <button type="button" class="btn btn-gradient product-main__sticky-btn" data-sticky-add-to-cart {% unless product.available %}disabled{% endunless %}>{% if product.available %}Add to Bag{% else %}Sold Out{% endif %}</button>
    </div>
  </div>
</section>

<script>
  // --- NEU: Lightbox Logik ---
  const allImages = [
    {% for image in product.images %}
      "{{ image | image_url: width: 2000 }}"{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];
  let lightboxIndex = 0;
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-image');

  window.openLightbox = function(idx) {
    lightboxIndex = idx;
    lightboxImg.src = allImages[idx];
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden'; // Scroll sperren
  }
  window.closeLightbox = function() {
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
  }
  window.changeSlide = function(dir) {
    lightboxIndex += dir;
    if(lightboxIndex >= allImages.length) lightboxIndex = 0;
    if(lightboxIndex < 0) lightboxIndex = allImages.length - 1;
    lightboxImg.src = allImages[lightboxIndex];
  }
  
  // Tastensteuerung
  document.addEventListener('keydown', e => {
    if(!lightbox.classList.contains('active')) return;
    if(e.key === "Escape") closeLightbox();
    if(e.key === "ArrowRight") changeSlide(1);
    if(e.key === "ArrowLeft") changeSlide(-1);
  });
  
  // Overlay Klick schließt
  lightbox.addEventListener('click', e => {
     if(e.target === lightbox) closeLightbox();
  });

  // --- BESTEHENDE LOGIK (UNVERÄNDERT, nur Mobile Gallery Update angepasst) ---
  const allProductImages = [
    {% for image in product.images %}
      { url: "{{ image | image_url: width: 800 }}", alt: "{{ image.alt | default: product.title | escape }}" }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];
  let currentGalleryImages = [...allProductImages];
  let currentMobileIndex = 0;
  
  document.addEventListener('DOMContentLoaded', function() {
    const firstColorSwatch = document.querySelector('.product-main__color-swatch.is-active');
    if (firstColorSwatch) updateGalleryForColor(firstColorSwatch);
  });
  
  function updateDesktopGallery(images) {
    const gallery = document.getElementById('desktop-gallery');
    if (!gallery || images.length === 0) return;
    // Update mit onclick Event
    gallery.innerHTML = images.map((img, index) => `
      <div class="product-main__image-item" onclick="openLightbox(${index})">
        <img src="${img.url}" alt="${img.alt}" loading="${index <= 1 ? 'eager' : 'lazy'}">
      </div>
    `).join('');
    // Aktualisiere auch Lightbox Array wenn sich die Galerie filtert (optional, hier laden wir einfach immer alle)
  }
  
  function updateMobileGallery(images) {
    if (images.length === 0) return;
    currentGalleryImages = images;
    currentMobileIndex = 0;
    const mobileImage = document.getElementById('product-mobile-image');
    if (mobileImage) { mobileImage.src = images[0].url; mobileImage.alt = images[0].alt; }
    const totalCounter = document.getElementById('mobile-image-total');
    if (totalCounter) totalCounter.textContent = images.length;
    const currentCounter = document.getElementById('mobile-image-current');
    if (currentCounter) currentCounter.textContent = 1;
  }
  
  function updateMobileImage(index) {
    if (currentGalleryImages.length === 0) return;
    currentMobileIndex = index;
    const mobileImage = document.getElementById('product-mobile-image');
    if (mobileImage) { mobileImage.src = currentGalleryImages[index].url; mobileImage.alt = currentGalleryImages[index].alt; }
    const counter = document.getElementById('mobile-image-current');
    if (counter) counter.textContent = index + 1;
  }
  
  document.querySelectorAll('.product-main__mobile-nav').forEach(btn => {
    btn.addEventListener('click', function() {
      const direction = this.dataset.mobileNav;
      if (direction === 'prev') {
        currentMobileIndex = (currentMobileIndex - 1 + currentGalleryImages.length) % currentGalleryImages.length;
      } else {
        currentMobileIndex = (currentMobileIndex + 1) % currentGalleryImages.length;
      }
      updateMobileImage(currentMobileIndex);
    });
  });
  
  function updateGalleryForColor(swatch) {
    const galleryImagesStr = swatch.dataset.galleryImages;
    if (galleryImagesStr && galleryImagesStr.length > 0) {
      const imageUrls = galleryImagesStr.split(',').filter(url => url.trim());
      const colorImages = imageUrls.map(url => ({ url: url.trim(), alt: swatch.dataset.value }));
      if (colorImages.length > 0) {
        updateDesktopGallery(colorImages);
        updateMobileGallery(colorImages);
        return;
      }
    }
    updateDesktopGallery(allProductImages);
    updateMobileGallery(allProductImages);
  }
  
  document.querySelectorAll('.product-main__color-swatch').forEach(btn => {
    btn.addEventListener('click', function() {
      const value = this.dataset.value;
      document.querySelectorAll('.product-main__color-swatch').forEach(b => b.classList.remove('is-active'));
      this.classList.add('is-active');
      const colorName = document.getElementById('selected-color-name');
      if (colorName) colorName.textContent = value;
      updateGalleryForColor(this);
      updateSizeAvailability();
      updateSelectedVariant();
    });
  });
  
  document.querySelectorAll('.product-main__size-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      if (this.disabled) return;
      document.querySelectorAll('.product-main__size-btn').forEach(b => b.classList.remove('is-active'));
      this.classList.add('is-active');
      updateSelectedVariant();
    });
  });
  
  document.querySelectorAll('.product-main__variant-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const group = this.closest('.product-main__variant-group');
      group.querySelectorAll('.product-main__variant-btn').forEach(b => b.classList.remove('is-active'));
      this.classList.add('is-active');
      updateSelectedVariant();
    });
  });
  
  function updateSizeAvailability() {
    const activeColor = document.querySelector('.product-main__color-swatch.is-active');
    if (!activeColor) return;
    const selectedColor = activeColor.dataset.value;
    const select = document.getElementById('product-select');
    const options = select.querySelectorAll('option');
    document.querySelectorAll('.product-main__size-btn').forEach(sizeBtn => {
      const sizeValue = sizeBtn.dataset.value;
      let isAvailable = false;
      for (const option of options) {
        const opt1 = option.dataset.option1;
        const opt2 = option.dataset.option2;
        const opt3 = option.dataset.option3;
        const hasColor = (opt1 === selectedColor || opt2 === selectedColor || opt3 === selectedColor);
        const hasSize = (opt1 === sizeValue || opt2 === sizeValue || opt3 === sizeValue);
        if (hasColor && hasSize && !option.disabled) { isAvailable = true; break; }
      }
      sizeBtn.disabled = !isAvailable;
    });
  }
  
  function updateSelectedVariant() {
    const selectedOptions = {};
    const activeColor = document.querySelector('.product-main__color-swatch.is-active');
    if (activeColor) selectedOptions[activeColor.dataset.option] = activeColor.dataset.value;
    const activeSize = document.querySelector('.product-main__size-btn.is-active');
    if (activeSize) selectedOptions[activeSize.dataset.option] = activeSize.dataset.value;
    document.querySelectorAll('.product-main__variant-btn.is-active').forEach(btn => {
      selectedOptions[btn.dataset.option] = btn.dataset.value;
    });
    const addBtn = document.getElementById('add-to-cart-btn');
    const hasSizeOption = document.querySelectorAll('.product-main__size-btn').length > 0;
    if (hasSizeOption && !activeSize) {
      addBtn.disabled = true;
      addBtn.classList.add('is-disabled');
      addBtn.textContent = addBtn.dataset.selectSize;
      return;
    }
    const select = document.getElementById('product-select');
    const options = select.querySelectorAll('option');
    for (const option of options) {
      let match = true;
      for (const [key, value] of Object.entries(selectedOptions)) {
        const opt1 = option.dataset.option1;
        const opt2 = option.dataset.option2;
        const opt3 = option.dataset.option3;
        if (opt1 !== value && opt2 !== value && opt3 !== value) { match = false; break; }
      }
      if (match) {
        select.value = option.value;
        if (option.disabled) {
          addBtn.disabled = true;
          addBtn.classList.add('is-disabled');
          addBtn.textContent = addBtn.dataset.soldOut;
        } else {
          addBtn.disabled = false;
          addBtn.classList.remove('is-disabled');
          addBtn.textContent = addBtn.dataset.addToCartText;
        }
        break;
      }
    }
  }
  updateSizeAvailability();
  
  document.querySelectorAll('.product-main__accordion-header').forEach(header => {
    header.addEventListener('click', function() {
      this.parentElement.classList.toggle('is-open');
    });
  });
  
  const form = document.getElementById('product-form');
  const stickyBar = document.getElementById('sticky-add-to-cart');
  if (form && stickyBar) {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) { stickyBar.classList.remove('is-visible'); } else { stickyBar.classList.add('is-visible'); }
      });
    }, { threshold: 0, rootMargin: '-80px 0px 0px 0px' });
    observer.observe(form);
  }
  
  document.querySelector('[data-sticky-add-to-cart]')?.addEventListener('click', () => {
    document.getElementById('product-form')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });
</script>

{% schema %}
{
  "name": "Product Main",
  "class": "section-product-main",
  "settings": []
}
{% endschema %}
